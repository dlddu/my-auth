name: Test

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true

      - name: Install golang-migrate
        run: |
          curl -fsSL https://github.com/golang-migrate/migrate/releases/download/v4.18.1/migrate.linux-arm64.tar.gz | tar xz
          sudo mv migrate /usr/local/bin/migrate
          migrate -version

      - name: Download dependencies
        run: go mod download

      - name: Verify module consistency
        run: go mod verify

      - name: Run go vet
        run: go vet ./...

      - name: Run tests with coverage
        run: go test -v -race -count=1 -coverprofile=coverage.out ./...

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.out
          retention-days: 7

  e2e:
    name: Playwright E2E
    runs-on: ubuntu-24.04-arm
    needs: test

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install npm dependencies
        run: npm ci

      - name: Install Playwright browsers and system dependencies
        run: npx playwright install --with-deps chromium

      - name: Build Go server
        run: go build -o bin/my-auth ./cmd/server

      - name: Create test config
        run: |
          printf '%s\n' \
            'issuer: "https://auth.test.local"' \
            'port: 8080' \
            'owner:' \
            '  username: "admin@test.local"' \
            '  password_hash: "$2a$12$f9hwtKC5D99r4BOC0UJwM.To6001PN8CS4TEVUEH.IQOGoPWuPZvy"' \
            'jwt_key_path: "keys/private.pem"' \
            > config.yaml

      - name: Start Go server in background
        # Run the built binary in the background. Playwright's webServer.url
        # probe will confirm the server is ready before tests start.
        # The process is terminated automatically when the job runner exits.
        # SEED_TEST_CLIENT=1 causes main.go to insert the well-known test-client
        # into the database so that E2E authorize tests can use it.
        run: SEED_TEST_CLIENT=1 ./bin/my-auth &

      - name: Run Playwright e2e tests
        # CI=true causes playwright.config.ts to set reuseExistingServer: false,
        # but we pass PLAYWRIGHT_REUSE_SERVER=1 to override that and use the
        # server started in the previous step instead of spawning a new one.
        # This avoids a second `go run` invocation and works with the stub server.
        run: npx playwright test
        env:
          CI: "true"
          # Tell playwright.config.ts that a server is already running.
          PLAYWRIGHT_REUSE_SERVER: "1"

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
